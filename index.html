<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>San Valentino: Riuscirà Bufetta a scoprire dove si andrà questa sera?</title>
  <style>
    /* RESET & BASE STYLES */
    * {
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #ffafbd 0%, #ffc3a0 100%);
      color: #451C1C;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    h1 {
      margin-top: 20px;
    }
    .info {
      text-align: center;
      margin-bottom: 10px;
      max-width: 500px;
      padding: 0 10px;
    }
    #gameContainer {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 40px;
    }
    canvas {
      background-color: #ffeff4;
      border: 3px solid #ff4d4d;
      border-radius: 10px;
    }
    #score {
      font-size: 1.5rem;
      margin: 10px;
      color: #ff4d4d;
    }
    #startBtn {
      padding: 0.7rem 1.2rem;
      font-size: 1rem;
      background-color: #ff4d4d;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 25px;
      transition: background-color 0.3s ease;
      margin: 10px;
    }
    #startBtn:hover {
      background-color: #ff6f6f;
    }
  </style>
</head>
<body>
  <h1>San Valentino: Flappy Heart + Quiz</h1>
  <div class="info">
    <p>
      Gioca a <strong>Flappy Heart</strong>: raggiungi <strong>8 punti</strong> per sbloccare la fase successiva!<br/>
      Clic o <strong>Barra Spaziatrice</strong> per saltare.<br/>
      Se fai Game Over, premi di nuovo Inizia per ripartire.
    </p>
  </div>
  <div id="gameContainer">
    <canvas id="gameCanvas" width="400" height="500"></canvas>
    <div id="score"></div>
    <button id="startBtn">Inizia!</button>
  </div>
  <script>
    ///////////////////////////////////////////
    // ========== FLAPPY HEART LOGIC =========
    ///////////////////////////////////////////

    // COSTANTI
    const TARGET_SCORE = 8; // Cambiato da 5 a 8
    const GRAVITY = 400;
    const JUMP = -200;
    const PIPE_SPEED = 70;
    const SPAWN_INTERVAL = 1.8;
    const PIPE_GAP = 120;
    const PIPE_WIDTH = 50;

    // Variabili di gioco
    let gameRunning = false;
    let lastTime = 0;
    let spawnTimer = 0;
    let score = 0;

    // Parametri del cuore
    let heartX = 50;
    let heartY = 0;
    let heartSize = 28;
    let velocityY = 0;

    // Tubi
    let pipes = [];

    // Canvas
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const W = canvas.width;
    const H = canvas.height;

    // Elementi HTML
    const scoreDisplay = document.getElementById('score');
    const startBtn = document.getElementById('startBtn');

    // Cuore immagine
    const heartImg = new Image();
    heartImg.src = 'https://cdn-icons-png.flaticon.com/512/2107/2107952.png';

    startBtn.addEventListener('click', startGame);

    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        flap();
      }
    });

    document.addEventListener('mousedown', (e) => {
      e.preventDefault();
      flap();
    });

    function startGame() {
      gameRunning = true;
      lastTime = 0;
      spawnTimer = 0;
      score = 0;
      heartY = H / 2;
      velocityY = 0;
      pipes = [];
      scoreDisplay.textContent = 'Score: 0';
      spawnPipe();
      requestAnimationFrame(gameLoop);
    }

    function flap() {
      if (!gameRunning) return;
      velocityY = JUMP;
    }

    function gameLoop(timestamp) {
      if (!gameRunning) return;
      let dt = (timestamp - lastTime) / 1000;
      lastTime = timestamp;
      if (dt < 0) dt = 0;
      if (dt > 0.05) dt = 0.05;
      update(dt);
      draw();
      requestAnimationFrame(gameLoop);
    }

    function update(dt) {
      velocityY += GRAVITY * dt;
      heartY += velocityY * dt;
      for (let i = 0; i < pipes.length; i++) {
        const p = pipes[i];
        p.x -= PIPE_SPEED * dt;
        if (!p.passed && (p.x + PIPE_WIDTH < heartX)) {
          p.passed = true;
          score++;
          scoreDisplay.textContent = `Score: ${score}`;
          if (score >= TARGET_SCORE) {
            gameVictory();
          }
        }
      }
      while (pipes.length && (pipes[0].x + PIPE_WIDTH < 0)) {
        pipes.shift();
      }
      spawnTimer += dt;
      if (spawnTimer >= SPAWN_INTERVAL) {
        spawnPipe();
        spawnTimer = 0;
      }
      if (heartY < 0) heartY = 0;
      if (heartY + heartSize > H) gameOver();
    }

    function draw() {
      ctx.clearRect(0, 0, W, H);
      ctx.drawImage(heartImg, heartX, heartY, heartSize, heartSize);
      ctx.fillStyle = '#f44336';
      for (let i = 0; i < pipes.length; i++) {
        const p = pipes[i];
        ctx.fillRect(p.x, 0, PIPE_WIDTH, p.topY);
        ctx.fillRect(p.x, p.topY + PIPE_GAP, PIPE_WIDTH, H - (p.topY + PIPE_GAP));
      }
    }

    function spawnPipe() {
      const minY = 50;
      const maxY = H - 50 - PIPE_GAP;
      const topY = Math.floor(Math.random() * (maxY - minY)) + minY;
      pipes.push({ x: W, topY: topY, passed: false });
    }

    function gameOver() {
      gameRunning = false;
      scoreDisplay.textContent = `Game Over! Score: ${score}`;
    }

    function gameVictory() {
      gameRunning = false;
      alert("Complimenti! Ora puoi accedere al quiz!");
    }
  </script>
</body>
</html>
